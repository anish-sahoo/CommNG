# Configuration Summary: Shared Domain with ALB

## Architecture Overview

```
User Request
    ↓
Application Load Balancer (ALB)
    ↓
    ├─→ /api/*, /trpc/* → Server (Node.js:3000)
    └─→ /* (everything else) → Web (Next.js:3001)
```

Both services share the same URL: `http://your-alb-dns-name.com`

## How It Works

### 1. **ALB Path-Based Routing**

The ALB listener rules route traffic:
- Pattern: `/api/*` → Server target group
- Pattern: `/trpc/*` → Server target group
- Default: `/*` → Web target group

### 2. **Same Domain, Different Services**

**From the user's perspective:**
- `http://your-app.com/` → Next.js homepage
- `http://your-app.com/login` → Next.js login page
- `http://your-app.com/api/trpc` → Node.js tRPC API
- `http://your-app.com/api/auth` → Node.js auth endpoints

### 3. **tRPC Configuration**

**Web side (query-provider.tsx):**
```typescript
const apiBase = process.env.NEXT_PUBLIC_API_BASE_URL;
const trpcUrl = apiBase ? `${apiBase}/api/trpc` : "/api/trpc";
```

**Behavior:**
- **Local dev**: `http://localhost:3000/api/trpc` (explicit server URL)
- **Production**: `http://alb-url.com/api/trpc` (same domain, ALB routes to server)
- **Fallback**: `/api/trpc` (relative path, works when same domain)

**Server side (index.ts):**
```typescript
app.use("/api/trpc", createExpressMiddleware({
  router: appRouter,
  createContext,
}));
```

Listens on `/api/trpc` endpoint at port 3000.

## Environment Variables

### Local Development

**server/.env.local:**
```bash
PORT=3000
DATABASE_URL=postgresql://...
REDIS_HOST=localhost
REDIS_AUTH=your-auth
VAPID_PUBLIC_KEY=BLZ07...
VAPID_PRIVATE_KEY=xYz...
```

**web/.env.local:**
```bash
PORT=3001
NEXT_PUBLIC_API_BASE_URL=http://localhost:3000  # Different domain in dev
NEXT_PUBLIC_WEB_BASE_URL=http://localhost:3001
NEXT_PUBLIC_VAPID_PUBLIC_KEY=BLZ07...
```

### Production/ECS

**Server environment (from Terraform):**
```bash
# Public env vars
NODE_ENV=production
PORT=3000
REDIS_HOST=<elasticache-endpoint>
DATABASE_HOST=<rds-endpoint>
S3_BUCKET=<bucket-name>

# From Secrets Manager
DATABASE_URL=<from-rds-secret>
REDIS_AUTH=<from-cache-secret>
VAPID_PUBLIC_KEY=<from-vapid-secret:publicKey>
VAPID_PRIVATE_KEY=<from-vapid-secret:privateKey>
```

**Web environment (from Terraform):**
```bash
# Public env vars
NODE_ENV=production
PORT=3001
NEXT_PUBLIC_API_BASE_URL=http://<alb-dns>  # Same as web URL!
NEXT_PUBLIC_WEB_BASE_URL=http://<alb-dns>

# From Secrets Manager
NEXT_PUBLIC_VAPID_PUBLIC_KEY=<from-vapid-secret:publicKey>
```

## Key Configuration Points

### ✅ No Changes Needed

1. **query-provider.tsx** - Already handles same domain correctly
2. **Server endpoints** - Already use `/api/trpc` prefix
3. **CORS** - Already allows same-origin with credentials

### ✅ Handled by Terraform

1. **ALB routing rules** - Automatically configured
2. **Environment variables** - Injected into containers
3. **Secrets Manager** - Values pulled at runtime
4. **Health checks** - ALB checks `/health` on server

### ⚠️ Manual Steps Required

1. **Generate VAPID keys**: `npx web-push generate-vapid-keys`
2. **Store in Secrets Manager**: See [SECRETS-SETUP.md](./SECRETS-SETUP.md)
3. **Initial Docker builds**: See [INFRA.md](./INFRA.md)

## Secrets Management

All secrets are stored in AWS Secrets Manager, not in code or Terraform:

| Secret | Location | Used By |
|--------|----------|---------|
| Database password | Auto-generated by RDS | Server |
| Redis AUTH | Auto-generated by Terraform | Server |
| VAPID keys (public, private, contact) | **Manual** (you create) | Server + Web |

**ECS Task Definition References Secrets:**
```terraform
secrets = [
  {
    name      = "VAPID_PUBLIC_KEY"
    valueFrom = "arn:aws:secretsmanager:...:publicKey::"
  }
]
```

At runtime, ECS:
1. Fetches secret from Secrets Manager
2. Extracts the JSON field (`publicKey`)
3. Injects as environment variable into container

**Result**: Your application code reads `process.env.VAPID_PUBLIC_KEY` normally.

## Testing the Setup

### 1. **Test ALB Routing**

```bash
# Get ALB URL
ALB_URL=$(terraform output -raw alb_dns_name)

# Test web (should return Next.js HTML)
curl http://$ALB_URL/

# Test server health check
curl http://$ALB_URL/health

# Test tRPC endpoint
curl http://$ALB_URL/api/trpc
```

### 2. **Verify Environment Variables in Container**

```bash
# List tasks
aws ecs list-tasks --cluster dev-comm-ng-cluster --service-name dev-comm-ng-server-service

# Describe task (shows env vars, secrets are masked)
aws ecs describe-tasks --cluster dev-comm-ng-cluster --tasks <task-arn>
```

### 3. **Check Application Logs**

```bash
# Server logs
aws logs tail /ecs/dev-comm-ng-server --follow

# Web logs
aws logs tail /ecs/dev-comm-ng-web --follow
```

Look for:
- No "undefined" environment variables
- Successful database connections
- No secret-related errors

## Common Issues

### Issue: tRPC calls fail with 404

**Cause**: ALB routing rule not matching

**Check**:
```bash
# Verify listener rules
aws elbv2 describe-rules --listener-arn <listener-arn>
```

Should show rule with path pattern `/api/*` and `/trpc/*`.

### Issue: CORS errors in browser

**Cause**: Origin mismatch

**Solution**: Both web and server use same domain via ALB, so CORS should work with `origin: true, credentials: true`.

### Issue: Environment variable is undefined

**Cause**: Secret not populated or wrong format

**Solution**: See [SECRETS-SETUP.md](./SECRETS-SETUP.md) troubleshooting section.

## Benefits of This Setup

1. ✅ **Single domain** - Users only see one URL
2. ✅ **No CORS issues** - Same-origin requests
3. ✅ **Clean URLs** - No ports in production
4. ✅ **SSL-ready** - Add certificate to ALB when ready
5. ✅ **Secure secrets** - Never exposed in code or logs
6. ✅ **Independent scaling** - Server and web scale separately
7. ✅ **Zero downtime** - ALB handles rolling deployments

## Next Steps

1. Complete initial deployment (see [INFRA.md](./INFRA.md))
2. Set up VAPID keys (see [SECRETS-SETUP.md](./SECRETS-SETUP.md))
3. Test all endpoints through ALB
4. Set up custom domain (optional)
5. Add SSL certificate (optional)
6. Configure GitHub Actions for CI/CD

---

**Last Updated**: November 2, 2025
